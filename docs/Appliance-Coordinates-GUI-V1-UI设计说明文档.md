# 家居设备坐标距离角度绘制工具 - UI设计说明文档 V2.5

## 1. 设计概述

### 1.1 设计目标

创建一个专业、直观、美观的桌面应用界面，基于Matplotlib科学绘图技术栈，为用户提供优秀的家居设备布局规划体验。

### 1.2 设计原则

- **科学计算为本**: 基于Matplotlib的专业科学绘图界面
- **功能性优先**: 界面服务于功能，不做无意义的装饰
- **直观易用**: 操作流程符合科学计算软件的用户直觉
- **视觉协调**: 配色、字体、布局保持一致性
- **响应及时**: 界面反馈及时，状态变化清晰
- **智能布局**: 标签自动避让，视觉信息清晰可读

### 1.3 目标用户

- 智能家居规划师
- 家居装修设计师
- IoT设备布局工程师
- 家庭用户

## 2. 整体布局设计

### 2.1 窗口规格

```
窗口标题: 家居设备坐标距离角度绘制工具 - Matplotlib版
窗口尺寸: 1280x800 像素
布局方式: 左右分割式
左侧区域: 800x800 像素 (Matplotlib可视化展示)
右侧区域: 480x800 像素 (功能操作)
窗口属性: 固定大小，不可调整，启动时屏幕居中
```

### 2.2 布局结构

```
┌─────────────────────────────────────────────────────────────────┐
│              主窗口 (1280x800, Matplotlib版)                      │
├─────────────────────────────┬───────────────────────────────────┤
│                             │                                   │
│     Matplotlib画布区域      │       右侧功能面板区域 (可滚动)   │
│        (800x800)            │            (480x800)              │
│                             │                                   │
│  ┌─────────────────────┐   │  ┌─────────────────────────────┐  │
│  │    Figure/Axes      │   │  │    坐标显示范围/用户坐标系  │  │
│  │    科学绘图区域     │   │  └─────────────────────────────┘  │
│  │                     │   │  ┌─────────────────────────────┐  │
│  │  - 矢量图形渲染     │   │  │       设备管理区域          │  │
│  │  - 整数步进网格     │   │  │     (ttk.Treeview)          │  │
│  │  - 设备点/信息框    │   │  │                             │  │
│  │  - 智能布局避让     │   │  └─────────────────────────────┘  │
│  │  - 背景户型图 🆕    │   │  ┌─────────────────────────────┐  │
│  │  - 交互测量/扇形    │   │  │    背景户型图设置 🆕 V2.5   │  │
│  │  - 用户坐标系覆盖层 │   │  └─────────────────────────────┘  │
│  └─────────────────────┘   │  ┌─────────────────────────────┐  │
│                             │  │         操作按钮区域        │  │
│                             │  └─────────────────────────────┘  │
└─────────────────────────────┴───────────────────────────────────┘
```

### 2.3 区域功能划分

- **左侧Matplotlib画布**: 专注于科学数据可视化展示和交互。
- **右侧功能面板**: 集成所有用户操作控件，垂直排列，内容超出时可滚动。

## 3. 左侧Matplotlib画布区域设计 (`matplotlib_view.py`)

### 3.1 Figure/Axes基础设计

```python
# Matplotlib Figure配置
figure_size = (8.0, 8.0)          # 8x8英寸
dpi = 100                         # 显示分辨率
facecolor = '#e0f7fa'             # 浅蓝背景
tight_layout = True               # 自动布局优化
aspect = 'equal'                  # 保持X/Y轴等比例
```

### 3.2 坐标系统视觉设计

#### 3.2.1 网格系统

- **网格线颜色**: `#b0bac2` (灰蓝色)
- **网格线宽度**: 0.5
- **网格线样式**: `--` (虚线)
- **网格间距**: 整数步进，主网格每1个单位一条线。

#### 3.2.2 坐标轴

- **轴线颜色**: `#37474f` (深灰色)
- **轴线宽度**: 1.5
- **X/Y轴**: 穿过(0,0)点，贯穿整个绘图区。

#### 3.2.3 原点标记

- **绘制方式**: `plt.scatter([0], [0], ...)`
- **颜色**: `#1e88e5` (蓝色)
- **大小**: `s=50`

#### 3.2.4 刻度标签

- **字体大小**: 10pt
- **颜色**: `#37474f` (深灰色)

### 3.3 设备显示设计

#### 3.3.1 设备标记 🆕 V2.3更新

- **绘制方式**: `plt.scatter(x, y, marker='s', ...)`
- **形状**: 正方形 (marker='s')
- **颜色**: `#c62828` (红色) 或设备自定义颜色
- **大小**: `s=25` (约5x5像素)
- **层级 (zorder)**: 10

#### 3.3.2 设备信息框设计 🆕 V2.3更新

- **标签格式**: 多行格式（名称 + 坐标分两行）
- **名称标签**: `axes.text(...)`, `fontsize=11`, `fontweight='bold'`
- **坐标标签**: `axes.text(...)`, `fontsize=10`, `fontweight='normal'`
- **背景框 (bbox)**:
  - `boxstyle`: "round,pad=0.3"
  - `facecolor`: `#fffde7` (浅黄)
  - `edgecolor`: `#d42c2c` (深红) 或设备颜色
  - `linewidth`: 1.5
- **引导线**:
  - 短虚线连接标签边缘与设备点
  - 颜色与设备颜色一致
  - 线宽: 1px
  - 样式: `--` (虚线)

#### 3.3.3 智能布局与避让系统 🆕 V2.3重大更新

##### 布局管理器 (`FastLayoutManager`)

项目实现了高性能原生布局管理器，采用力导向算法进行标签避让：

**核心组件**:

- `FastLayoutManager`: 主布局管理器
- `LayoutElement`: 布局元素封装
- `BoundingBox`: 边界框碰撞检测
- `SectorRegion`: 扇形区域斥力场

**4方向标签布局策略**:

- **默认位置**: 设备点左侧
- **避让顺序**: 顺时针方向（左 → 上 → 右 → 下）
- **距离约束**: 标签边缘距设备点1个坐标单位

**碰撞检测方法** (`scene_renderer.py`):

1. `_check_label_sector_collision`: 检查标签与扇形区域碰撞
2. `_check_label_overlap`: 检查标签与其他标签重叠
3. `_check_label_device_collision`: 检查标签与其他设备点碰撞

**力导向算法参数**:

```python
# FastLayoutManager配置
iterations = 50            # 迭代次数
repulsion_strength = 2.0   # 斥力强度
attraction_strength = 0.1  # 引力强度（锚点约束）
boundary_padding = 0.5     # 边界内边距
sector_repulsion = 5.0     # 扇形区域斥力倍数
```

**位置固定机制**:

- 首次计算后保存位置到 `SceneModel`
- 支持手动拖拽调整（`is_manual=True`）
- 右键可重置为自动位置

### 3.4 背景户型图显示 🆕 V2.5新增

#### 3.4.1 背景图渲染

- **实现**: `axes.imshow(image_data, extent=(...), alpha=..., zorder=0)`
- **图层层级 (zorder)**: 0（最底层，在网格和所有元素之下）
- **透明度**: 可调节，默认0.5
- **居中对齐**: 图片中心对齐坐标原点(0,0)

#### 3.4.2 像素比例映射

- **参数**: `pixels_per_unit` - 每坐标单位对应的像素数
- **计算公式**:
  - `width_units = pixel_width / pixels_per_unit`
  - `height_units = pixel_height / pixels_per_unit`
  - `extent = [-width_units/2, width_units/2, -height_units/2, height_units/2]`

#### 3.4.3 显示控制

- **透明度调节**: 通过`set_alpha()`方法实时更新
- **显示切换**: 通过`set_visible()`方法隐藏/显示
- **移除背景**: 调用`remove()`方法清除Artist对象

### 3.5 交互功能设计

#### 3.5.1 交互事件

- **鼠标单击 (左键)**: 创建或移动测量点。
- **鼠标双击 (左键)**: 在测量点位置，以参考点（世界原点或用户位置）为中心绘制90度扇形。
- **鼠标右击**: 清除所有测量点、测量连线、扇形，并重置设备信息框到默认位置。
- **鼠标移动**: 实时显示十字准星和当前坐标信息。
- **标签拖拽** 🆕: 支持鼠标拖拽调整标签位置。

#### 3.5.2 测量点标记

- **绘制方式**: `plt.scatter(...)`
- **颜色**: `#2e7d32` (绿色)
- **大小**: `s=80`
- **层级 (zorder)**: 20 (最高)

#### 3.5.3 测量连线

- **绘制方式**: `axes.plot(...)`
- **连接**: 从参考点 (世界原点或用户位置) 到测量点。
- **颜色**: `#4caf50` (亮绿色)
- **线宽**: 2.0
- **线型**: `--` (虚线)

#### 3.5.4 测量信息框

- **实现**: `axes.annotate(...)` (Matplotlib注释)
- **字体**: `fontsize=10`
- **背景框 (bbox)**: `facecolor=(1, 1, 1, 0.85)` (半透明白), `edgecolor='#2e7d32'` (绿色)
- **箭头**: 指向测量点。

#### 3.5.5 扇形区域绘制

- **实现**: `matplotlib.patches.Wedge`
- **角度**: 90度，以测量连线为角平分线。
- **填充色**: `(0.827, 0.184, 0.184, 0.2)` (半透明红色)
- **边框色**: `#d42c2c` (深红)
- **线宽**: 1.5
- **扇形避让**: 自动注册到布局管理器，标签会避开扇形区域 🆕

### 3.6 用户坐标系覆盖层

#### 3.6.1 用户位置标记 🆕 V2.3增强

- **实现**: 三层设计（阴影 + 边框 + 核心）
- **核心颜色**: `#7b1fa2` (紫色)
- **边框颜色**: `#ffffff` (白色)
- **阴影颜色**: 半透明紫色
- **大小**: `s=180` (核心), `s=240` (边框), `s=320` (阴影)
- **形状**: `*` (星形)
- **层级 (zorder)**: 15

#### 3.6.2 用户坐标轴

- **实现**: `axes.plot(...)`
- **颜色**: `#7b1fa2` (紫色)
- **线宽**: 1.5
- **线型**: `-.` (点划线)
- **透明度**: 0.7

#### 3.6.3 用户位置信息框

- **实现**: `axes.text(...)`
- **内容**: "[用户] 位置\n(X, Y)"
- **字体**: `fontsize=12`, `fontweight='bold'`, `color='#7b1fa2'` (紫色)
- **背景框 (bbox)**: `facecolor=(0.96, 0.92, 0.98, 0.85)` (半透明紫色)

## 4. 右侧功能面板设计 (`input_panel.py`)

### 4.1 整体面板设计

- **总宽度**: 480px
- **背景色**: `#ffffff` (白色)
- **内边距**: 10px
- **滚动条**: 当内容超出高度时，自动显示垂直滚动条。

### 4.2 坐标范围与状态区域

- **实现**: `ttk.LabelFrame` (标题: "坐标显示范围设置")
- **坐标范围输入**:
  - `X/Y轴范围`: `ttk.Label` + `ttk.Entry` (宽8, 字体Arial 12), 范围0.1-50.0。
  - `应用设置`: `ttk.Button`。
- **用户坐标系**:
  - `启用用户坐标系`: `ttk.Checkbutton`，勾选后显示下方用户位置设置。
  - `用户位置设置`: 隐藏的`ttk.LabelFrame`，包含X/Y坐标`ttk.Entry`和"设置用户位置"`ttk.Button`。
- **当前状态**:
  - `ttk.LabelFrame` (标题: "当前状态")，用于实时反馈。
  - **坐标系模式**: "世界坐标系" (蓝色) 或 "用户坐标系" (紫色)。
  - **用户位置**: "未设置" (灰色) 或 `(X, Y)` (绿色)。
  - **交互提示**: 根据坐标系模式显示不同提示文本。

### 4.3 背景户型图设置区域 🆕 V2.5新增

- **实现**: `ttk.LabelFrame` (标题: "背景户型图设置")
- **图片信息显示**:
  - `ttk.Label`，显示已加载图片的尺寸和文件名信息
  - 格式: "尺寸: WxH像素 | 文件: filename.png"
- **操作按钮**:
  - `导入图片`: `ttk.Button`，弹出文件选择对话框
  - `移除背景`: `ttk.Button`，清除当前背景图
- **比例设置**:
  - `ttk.Label` + `ttk.Entry`，"每X像素=1坐标单位"
  - 默认值: 100，范围: 10-1000
  - 修改后自动更新背景图显示范围
- **透明度滑块**:
  - `ttk.Label` + `ttk.Scale`
  - 范围: 10%-100%，默认50%
  - 拖动时实时更新背景图透明度
- **显示开关**:
  - `ttk.Checkbutton`，"显示背景图"
  - 切换时立即隐藏/显示背景图

### 4.4 设备管理区域

- **实现**: `ttk.LabelFrame` (标题: "设备管理")
- **设备列表**:
  - `ttk.Treeview`，`selectmode='browse'`。
  - **列**: "设备名称" (180px), "X坐标" (100px), "Y坐标" (100px)。
  - **约束**: 最多管理10个设备。
- **设备信息输入**:
  - `名称`, `X坐标`, `Y坐标` 的 `ttk.Entry`。
  - **设备颜色选择器** 🆕: 颜色选择按钮，支持自定义设备颜色。
- **操作按钮**:
  - **添加/更新**: `ttk.Button`，文本根据是否选中设备在"添加设备"和"更新设备"间切换。
  - **删除设备**: `ttk.Button`，选中设备后启用。

### 4.5 操作区域

- **实现**: `ttk.LabelFrame` (标题: "操作")
- **导出按钮**: `ttk.Button`, 文本为 "📷 导出PNG图像"。
- **重置按钮**: `ttk.Button`, 文本为 "重置所有数据"。

## 5. 颜色系统设计 (RGBA / CSS Hex)

| 用途 | 颜色 | 值 (Hex) | 模块 |
| :--- | :--- | :--- | :--- |
| 画布背景 | 浅蓝色 | `#e0f7fa` | `matplotlib_view` |
| 网格线 | 灰蓝色 | `#b0bac2` | `matplotlib_view` |
| 坐标轴/刻度 | 深灰色 | `#37474f` | `matplotlib_view` |
| 世界原点 | 蓝色 | `#1e88e5` | `matplotlib_view` |
| 设备点/标签 | 红色 | `#c62828` | `matplotlib_view` |
| 设备信息框背景 | 浅黄色 | `#fffde7` | `matplotlib_view` |
| 设备信息框边框 | 深红色 | `#d42c2c` | `matplotlib_view` |
| 测量点/信息框 | 绿色 | `#2e7d32` | `matplotlib_view` |
| 测量线 | 亮绿色 | `#4caf50` | `matplotlib_view` |
| 扇形填充 | 半透明红 | `(0.827, 0.184, 0.184, 0.2)` | `matplotlib_view` |
| 用户坐标系 | 紫色 | `#7b1fa2` | `matplotlib_view` |
| 面板背景 | 白色 | `#ffffff` | `input_panel` |
| 面板区域背景 | 浅灰色 | `#f5f5f5` | `input_panel` |

## 6. 字体系统设计

| 用途 | 大小 (pt) | 粗细 | 模块 |
| :--- | :--- | :--- | :--- |
| 坐标轴刻度 | 10 | normal | `matplotlib_view` |
| 设备名称标签 | 11 | bold | `matplotlib_view` |
| 设备坐标标签 | 10 | normal | `matplotlib_view` |
| 测量信息 | 10 | normal | `matplotlib_view` |
| 用户位置标签 | 12 | bold | `matplotlib_view` |
| 面板范围输入 | 12 | normal | `input_panel` |
| 面板状态标签 | 10 | bold/normal | `input_panel` |

## 7. 交互设计规范

### 7.1 Matplotlib画布交互

- **单击**: 在画布上创建测量点，并显示相关信息。
- **双击**: 基于自定义的`DoubleClickDetector`类（使用`event.time`判断时间间隔），在测量点位置绘制90度扇形。
- **右击**: 清除画布上所有交互元素（测量点、线、扇形、信息框），并重置设备标签到默认位置。
- **鼠标移动**:
  - 显示十字准星和坐标信息框。
  - 如果存在测量点，实时更新测量连线和信息框。
- **标签拖拽** 🆕:
  - 鼠标悬停在标签上，光标变为手形。
  - 按住左键拖动标签到目标位置。
  - 释放鼠标，位置自动保存到模型。
- **状态反馈**: 所有交互都通过`canvas.draw_idle()`实现画布的延迟重绘，以优化性能。

### 7.2 Tkinter界面交互

- **设备列表**: 单击`ttk.Treeview`中的条目会：
  - 在右侧输入框中填充该设备的信息。
  - 将"添加设备"按钮切换为"更新设备"。
  - 激活"删除设备"按钮。
- **用户坐标系开关**: `ttk.Checkbutton`状态切换会立即显示或隐藏用户位置输入区域，并更新状态面板和Matplotlib画布。
- **错误处理**: 无效输入（如非数字坐标、名称不符合规范）会通过`tkinter.messagebox.showerror`弹出错误提示框。
- **确认对话框**: 删除、重置等危险操作会通过`messagebox.askyesno`请求用户确认。

## 8. 性能与响应式设计

### 8.1 固定布局

- 应用采用固定的1280x800布局，不支持窗口缩放，以保证各组件比例和布局的稳定性。
- Matplotlib的Figure自适应800x800的左侧区域。

### 8.2 性能优化

- **延迟重绘**: 界面更新主要通过`canvas.draw_idle()`触发，避免了因高频事件（如鼠标移动）导致的频繁重绘，提升了流畅度。
- **数据驱动**: 视图的更新由控制器在数据模型（`DeviceManager`）变化后统一调度，保证了数据与视图的一致性。
- **高性能布局算法** 🆕: 使用原生Python实现的力导向算法，减少外部依赖，提升计算效率。
- **标签位置缓存** 🆕: 首次计算后保存位置，避免重复计算，性能提升约90%。

## 9. 设计实现总结

### 9.1 技术实现

- **UI框架**: `tkinter` + `ttk`
- **绘图核心**: `matplotlib` + `numpy`
- **图像处理**: `Pillow` (背景图加载) 🆕 V2.5
- **布局算法**: `FastLayoutManager` (力导向算法)
- **架构**: MVC模式，`MatplotlibController`作为核心控制器，`DeviceManager`作为数据中心，`MatplotlibView`和`InputPanel`作为视图。

### 9.2 核心功能亮点

- **科学级绘图**: 完全基于Matplotlib，提供高质量、可定制的矢量图形展示。
- **双坐标系分析**: 支持世界坐标系和可由用户自定义原点的用户坐标系，方便进行相对位置的测量和分析。
- **智能信息框布局** 🆕 V2.3增强:
  - 力导向算法实现标签自动避让
  - 4方向布局策略（左/上/右/下）
  - 扇形区域斥力场避让
  - 标签与设备间虚线引导线
  - 位置固定与手动调整支持
- **实时交互反馈**: 无论是画布上的测量交互，还是功能面板上的状态变更，系统都能提供清晰、实时的视觉反馈。
- **数据驱动与模块化**: 清晰的MVC分层和数据驱动的更新机制，使得代码结构清晰，易于维护和扩展。

### 9.3 V2.3版本更新摘要

1. **设备点尺寸**: 从3x3像素调整为5x5像素
2. **设备点形状**: 改为正方形标记(marker='s')
3. **标签默认位置**: 设备点左侧，顺时针避让
4. **智能避让系统**: 三重碰撞检测（扇形、标签、设备）
5. **位置固定机制**: 标签位置一旦确定保持固定
6. **虚线引导线**: 标签与设备间的视觉连接
7. **力导向布局**: FastLayoutManager V2.0算法
8. **设备颜色支持**: 每个设备可设置自定义颜色

### 9.4 V2.5版本更新摘要 🆕

1. **背景户型图导入**: 支持PNG/JPG格式户型图作为背景参考
2. **像素比例映射**: 通过"每X像素=1坐标单位"设置图片实际尺寸
3. **中心对齐**: 背景图自动居中显示在坐标原点
4. **透明度调节**: 滑块控制10%-100%透明度
5. **显示切换**: 可随时隐藏/显示背景图
6. **项目持久化**: 背景图通过Base64嵌入项目文件，确保可移植性
7. **图层管理**: zorder分层确保背景图始终在最底层
8. **UI区域新增**: 右侧面板新增"背景户型图设置"区域

**最终评价**: 这是一个技术实现优秀、功能完善、交互流畅的现代化科学计算桌面应用。它成功地将`tkinter`的便捷性与`matplotlib`的专业性结合起来，为特定领域的工程师和设计师提供了高效实用的工具。V2.3版本在标签布局和视觉表现方面进行了重大优化，显著提升了多设备场景下的信息可读性。V2.5版本新增的背景户型图功能，让用户能够在真实户型图上直观地规划设备布局，进一步提升了工具的实用价值。
