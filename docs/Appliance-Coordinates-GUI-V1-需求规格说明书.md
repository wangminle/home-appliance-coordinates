# 家居设备坐标距离角度绘制工具 - 需求规格说明书 V2.7

## 1. 项目背景与目标

### 1.1 项目背景

随着智能家居设备的普及，需要一个可视化工具来帮助用户规划和分析家居设备在空间中的布局，计算设备间的距离和角度关系，为设备覆盖范围分析和空间优化提供支持。

### 1.2 项目目标

开发一个基于Python的桌面GUI客户端，提供直观的坐标可视化界面，支持动态设备管理和精确的几何计算功能。采用现代Matplotlib科学计算技术栈，提供专业级的绘图和分析功能。

### 1.3 目标用户

- 智能家居规划师
- 家居装修设计师  
- IoT设备布局工程师
- 家庭用户

## 2. 功能需求

### 2.1 主界面需求

#### 2.1.1 整体布局要求

- **窗口尺寸**: 固定1280x800像素
- **布局方式**: 左右分割布局
- **左侧区域**: 800x800像素，用于Matplotlib坐标可视化展示
- **右侧区域**: 480x800像素，用于功能操作面板
- **窗口属性**: 可最小化，不可调整大小，居中显示

#### 2.1.2 视觉设计要求

- **配色方案**: 与参考HTML保持一致，支持Matplotlib颜色格式
  - 背景色: `(0.878, 0.969, 0.980)` (浅蓝色)
  - 网格线: `(0.690, 0.737, 0.773)` (灰蓝色)
  - 坐标轴: `(0.216, 0.278, 0.310)` (深灰色)
  - 设备点: `(0.776, 0.157, 0.157)` (红色) 或自定义颜色
  - 原点: `(0.118, 0.533, 0.898)` (蓝色)
- **字体要求**:
  - 支持中文的系统字体
  - 坐标标签: 10px
  - 设备标签: 11px加粗（名称）+ 10px（坐标）
  - 坐标信息: 14px加粗

### 2.2 左侧Matplotlib展示区需求

#### 2.2.1 坐标系统显示

- **坐标范围**: 默认-5到+5的X/Y轴范围，支持动态调整
- **网格系统**: 每1个单位绘制一条网格线，修复为整数步进显示
- **坐标轴**: X轴和Y轴加粗显示，原点标记
- **刻度标签**: 在坐标轴上显示整数数值标签
- **原点标识**: 蓝色圆点标记坐标原点(0,0)

#### 2.2.2 设备点显示 🆕 V2.3更新

- **设备标记**: 红色或自定义颜色的正方形(5x5像素)，使用Matplotlib scatter绘制
- **设备标签**: matplotlib text对象，多行格式显示（名称+坐标）
- **标签定位**: 智能4方向布局，默认左侧，顺时针避让
- **引导线**: 虚线连接标签边缘与设备点

#### 2.2.3 交互功能

- **鼠标悬停**: 显示坐标信息，实时跟踪
  - 同时显示**世界坐标**(设备绝对位置)和**用户坐标**(相对用户位置) ✨ 双坐标系核心功能
- **左键单击**: 有两种交互模式
  - **普通测量模式**: 创建测量点，显示到世界原点的距离角度
  - **用户位置设置模式**: 设置用户当前位置(动态坐标系原点) ✨ 用户中心设计
- **左键双击**: 绘制90度扇形覆盖区域 ✨
- **右键点击**: 清除所有测量点、扇形和相关信息，重置设备标签到默认位置
- **坐标显示模式**: 用户设置位置后，所有坐标信息同时显示两套数值
- **标签拖拽** 🆕: 支持鼠标拖拽调整设备标签位置
- **背景户型图** 🆕 V2.5: 支持导入PNG/JPG户型图作为背景参考

#### 2.2.4 双坐标系显示 ✨ 核心创新功能

- **世界坐标系(主坐标系)**: 固定的家居环境坐标系
  - 黑色网格线和坐标轴，表示房间/建筑物的固定参考系
  - 设备在此坐标系中的位置代表其在家居环境中的绝对位置
- **用户坐标系(动态坐标系)**: 以用户位置为原点的相对坐标系
  - 用紫色星形图标显示用户当前位置（三层设计：阴影+边框+核心）
  - 用虚线绘制以用户为原点的辅助坐标轴
  - 实时计算并显示设备相对于用户位置的坐标、距离、角度
- **双重信息显示**: 鼠标悬停时同时显示两套坐标信息
  - 世界坐标: (X_world, Y_world)
  - 用户相对坐标: (X_user, Y_user)
  - 到世界原点距离: D_world
  - 到用户位置距离: D_user

#### 2.2.5 扇形区域显示 ✨

- **扇形绘制**: 90度扇形区域显示
- **半透明填充**: 使用matplotlib Wedge对象
- **动态生成**: 基于双击位置和角度计算
- **标签避让** 🆕: 扇形区域自动注册到布局管理器，标签会避开扇形

#### 2.2.6 智能标签布局 🆕 V2.3核心新功能

- **力导向算法**: 使用FastLayoutManager实现标签自动避让
- **4方向布局**: 标签位置选择（左/上/右/下），顺时针避让
- **碰撞检测**: 三重检测（扇形、其他标签、设备点）
- **位置固定**: 标签位置一旦确定保持固定，避免重复计算
- **手动调整**: 支持拖拽调整标签位置

#### 2.2.7 背景户型图显示 🆕 V2.5核心新功能

- **图片导入**: 支持PNG/JPG格式户型图作为背景
- **像素比例映射**: 通过"每X像素=1坐标单位"设置图片实际尺寸
- **中心对齐**: 背景图自动居中显示在坐标原点
- **透明度调节**: 10%-100%透明度可调，默认50%
- **显示切换**: 可随时隐藏/显示背景图
- **图层管理**: zorder分层确保背景图始终在最底层
- **项目持久化**: 背景图通过Base64嵌入项目文件，确保可移植性

### 2.3 右侧输入面板需求

#### 2.3.1 坐标范围设置区域

**位置**: 右侧面板顶部，高度约150px

**组件要求**:

- **标题**: "坐标显示范围设置"
- **X轴范围输入**:
  - 标签: "X轴范围 (±)"
  - 输入框: 数字输入，默认值5
  - 单位: 显示单位标识
- **Y轴范围输入**:
  - 标签: "Y轴范围 (±)"  
  - 输入框: 数字输入，默认值5
  - 单位: 显示单位标识
- **应用按钮**: 立即应用新的坐标范围设置

**交互逻辑**:

- 输入框支持小数输入
- 范围值限制: 0.1-50
- 输入后回车键或点击应用按钮生效
- 立即更新Matplotlib坐标系显示范围
- 重新计算所有元素的缩放比例

#### 2.3.2 设备管理区域

**位置**: 右侧面板中部，高度约500px

**组件要求**:

- **标题**: "设备管理"
- **设备列表**:
  - 使用Tkinter Treeview组件显示已添加设备
  - 列: 序号、设备名称、X坐标、Y坐标
  - 支持单选选中设备
  - 显示滚动条（设备数量超出显示区域时）

- **设备信息输入区**:
  - **设备名称输入框**:
    - 标签: "设备名称"
    - 文本输入框，最大长度20字符
    - 占位符: "请输入设备名称"
  - **X坐标输入框**:
    - 标签: "X坐标"
    - 数字输入框，支持小数
    - 占位符: "0.000"
  - **Y坐标输入框**:
    - 标签: "Y坐标"
    - 数字输入框，支持小数
    - 占位符: "0.000"
  - **颜色选择器** 🆕:
    - 标签: "设备颜色"
    - 颜色选择按钮，支持自定义设备颜色

- **操作按钮组**:
  - **添加设备按钮** (绿色):
    - 图标: "+" 加号
    - 文本: "添加设备"
    - 快捷键: Ctrl+A
  - **删除设备按钮** (红色):
    - 图标: "-" 减号
    - 文本: "删除设备"
    - 仅在选中设备时启用
    - 快捷键: Delete
  - **确认修改按钮** (蓝色):
    - 图标: "✓" 对勾
    - 文本: "确认修改"
    - 仅在选中设备且信息有变化时启用
    - 快捷键: Ctrl+S

**交互逻辑**:

- 选中设备列表中的设备时，自动填充输入框
- 添加设备时验证名称唯一性
- 坐标输入支持负数和小数
- 修改设备信息后需点击确认按钮生效
- 设备变更立即反映到Matplotlib画布

#### 2.3.3 操作按钮区域

**位置**: 右侧面板底部，高度约150px

**组件要求**:

- **用户位置设置按钮**: ✨ 双坐标系核心功能
  - 尺寸: 大按钮样式
  - 图标: 用户位置图标
  - 文本: "设置用户位置"
  - 颜色: 特殊功能色（紫色）
  - 快捷键: Ctrl+U
  - 说明: 点击后进入用户位置设置模式

- **导出PNG按钮**:
  - 尺寸: 大按钮样式
  - 图标: 下载图标
  - 文本: "导出高清PNG"
  - 颜色: 主要操作色（蓝色）
  - 快捷键: Ctrl+E

- **重置按钮**:
  - 尺寸: 大按钮样式
  - 图标: 重置图标
  - 文本: "重置所有数据"
  - 颜色: 警告色（橙色）
  - 快捷键: Ctrl+R

**交互逻辑**:

- **用户位置设置**: 点击按钮后进入设置模式，在画布上点击设置用户位置
- 导出PNG时显示文件保存对话框，支持多格式导出 (PNG/SVG/PDF)
- 重置前弹出确认对话框，清空设备、测量点和用户位置
- 重置恢复默认5x5坐标范围和单一世界坐标系显示

#### 2.3.4 背景户型图设置区域 🆕 V2.5新增

**位置**: 右侧面板坐标范围设置区域下方，约150px高度

**组件要求**:

- **标题**: "背景户型图设置"
- **图片信息显示**: 显示已加载图片的尺寸和路径信息
- **导入按钮**: "📁 导入图片"，支持PNG/JPG格式
- **移除按钮**: "🗑️ 移除背景"，清除当前背景图
- **比例设置**: 
  - 标签: "每X像素=1单位"
  - 输入框: 数字输入，默认值100
  - 范围: 10-1000
- **透明度滑块**:
  - 标签: "透明度"
  - 滑块: 10%-100%范围
  - 默认值: 50%
  - 实时更新显示
- **显示开关**: 复选框控制背景图显示/隐藏

**交互逻辑**:

- 点击导入按钮弹出文件选择对话框
- 修改比例值后自动更新背景图显示范围
- 拖动透明度滑块实时更新背景图透明度
- 切换显示开关立即隐藏/显示背景图
- 移除背景图前弹出确认对话框

### 2.4 数据管理需求

#### 2.4.1 设备数据结构 (V2.3增强)

```
设备对象 = {
    device_id: 唯一标识符(UUID),
    name: 设备名称(字符串),
    x: X坐标(浮点数),
    y: Y坐标(浮点数),
    created_time: 创建时间(时间戳),
    color: 设备颜色(可选, 字符串),  // 🆕
    info_position: 标签位置(可选, 字符串),  // 🆕
    default_info_position: 默认标签位置(可选, 字符串),  // 🆕
    is_info_position_forced: 是否被强制避让(布尔值)  // 🆕
}
```

#### 2.4.2 数据验证规则

- **设备名称**: 1-20字符，不能为空，同一项目内唯一
- **坐标值**: 数字类型，支持小数，范围在当前坐标系范围内
- **坐标范围**: 0.1-50之间的正数
- **设备数量**: 最多支持100个设备

#### 2.4.3 设备管理器架构 ✅ (已实现)

- **单一数据源**: DeviceManager统一管理所有设备数据
- **事务式操作**: 支持原子性操作和自动回滚
- **观察者模式**: 数据变更自动通知相关组件
- **完整验证**: 多层次数据验证机制

#### 2.4.4 场景模型 🆕 V2.3新增

```
场景对象 = {
    devices: 设备列表,
    label_positions: {  // 标签位置缓存
        element_id: {
            x: X坐标,
            y: Y坐标,
            is_manual: 是否手动设置,
            direction: 方向标识(left/top/right/bottom)
        }
    },
    sectors: 扇形区域列表,
    measurement_point: 当前测量点
}
```

#### 2.4.5 背景户型图数据模型 🆕 V2.5新增

```
背景图对象 = {
    image_path: 图片文件路径(字符串),
    image_data_base64: Base64编码图片数据(字符串),
    pixel_width: 图片像素宽度(整数),
    pixel_height: 图片像素高度(整数),
    pixels_per_unit: 每坐标单位对应像素数(浮点数, 默认100),
    alpha: 透明度(浮点数, 0.1-1.0, 默认0.5),
    enabled: 是否启用显示(布尔值, 默认true),
    x_min: 计算后的X最小值(浮点数),
    x_max: 计算后的X最大值(浮点数),
    y_min: 计算后的Y最小值(浮点数),
    y_max: 计算后的Y最大值(浮点数)
}
```

### 2.5 计算功能需求

#### 2.5.1 距离计算

- **算法**: 欧几里得距离公式
- **精度**: 保留3位小数
- **显示**: 实时计算并显示测量点到原点的距离

#### 2.5.2 角度计算

- **定义**: 计算测量点与坐标轴的最小夹角
- **算法**: 使用反正切函数计算
- **单位**: 度数，保留3位小数
- **范围**: 0-90度

#### 2.5.3 坐标转换

- **逻辑坐标**: 用户输入的数学坐标
- **画布坐标**: Matplotlib figure坐标
- **转换精度**: 支持亚像素级精度
- **实时转换**: 支持坐标范围动态调整

### 2.6 导出功能需求

#### 2.6.1 多格式导出 ✨ 增强功能

- **PNG导出**: 高分辨率栅格图像，至少300 DPI
- **SVG导出**: 可缩放矢量图形，支持编辑
- **PDF导出**: 文档级矢量输出，适合打印
- **EPS导出**: 专业印刷格式 (可选)

#### 2.6.2 文件保存

- **默认文件名**: "家居设备布局图_YYYYMMDD_HHMMSS.png"
- **保存位置**: 用户选择，默认为用户文档目录
- **macOS兼容**: 修复文件对话框参数兼容性
- **错误处理**: 导出失败时显示友好错误信息

### 2.7 数据持久化需求

#### 2.7.1 项目文件管理

- **文件格式**: JSON格式（.apc扩展名 - Appliance Coordinates Project）
- **文件内容**:
  - 项目元信息（名称、版本、创建时间、修改时间、描述、作者）
  - 设备列表（完整的设备数据，含颜色和标签位置）
  - 坐标系统设置（X/Y轴范围）
  - 用户坐标系设置（启用状态、用户位置）
  - 背景户型图数据（图片Base64、比例、透明度）🆕 V2.5
- **版本管理**: 支持版本号标记，为未来升级预留兼容性

#### 2.7.2 文件菜单功能

- **新建项目 (Ctrl+N)**: 清空当前数据，创建新项目
- **打开项目 (Ctrl+O)**: 从文件加载完整项目状态
- **保存项目 (Ctrl+S)**: 保存到当前项目文件
- **另存为 (Ctrl+Shift+S)**: 保存到新文件路径
- **默认目录**: `文档/ApplCoordProjects/`
- **保存检查**: 关闭或新建项目前提示保存未保存的更改

#### 2.7.3 CSV设备列表导入/导出

- **CSV格式**:

  ```csv
  设备名称,X坐标,Y坐标
  7寸屏,-2.625,0.000
  4寸屏,-1.000,3.544
  ```

## 3. 非功能需求

### 3.1 性能需求

- **启动时间**: 应用启动时间不超过3秒
- **响应时间**: 界面操作响应时间不超过100ms
- **绘制性能**: 支持至少100个设备点的流畅显示
- **内存占用**: 正常使用时内存占用不超过200MB
- **矢量性能**: Matplotlib矢量渲染，支持无损缩放
- **布局性能** 🆕: 标签位置缓存后，重复渲染性能提升~90%

### 3.2 兼容性需求

- **操作系统**: Windows 10+, macOS 10.14+, Ubuntu 18.04+
- **Python版本**: Python 3.12
- **依赖库**: matplotlib >= 3.7.0, numpy >= 1.24.0, pillow >= 10.0.0
- **屏幕分辨率**: 支持1280x800以上分辨率
- **DPI适配**: 支持高DPI显示器，Matplotlib自动处理

### 3.3 可用性需求

- **界面直观**: 界面操作直观，无需培训即可使用
- **错误提示**: 提供友好的错误提示信息
- **快捷键**: 提供常用操作的快捷键支持
- **撤销功能**: 支持操作撤销（通过右键清除）
- **标签调整** 🆕: 支持手动拖拽调整标签位置

### 3.4 可维护性需求

- **代码结构**: 采用MVC架构，模块化设计
- **代码注释**: 所有代码使用中文注释
- **文档完整**: 提供完整的技术文档
- **测试覆盖**: 核心功能有单元测试覆盖

## 4. 界面交互流程

### 4.1 应用启动流程

```
1. 启动应用
2. 初始化Matplotlib组件
3. 初始化FastLayoutManager布局管理器  🆕
4. 加载默认5x5坐标系
5. 显示空白画布
6. 等待用户操作
```

### 4.2 设备管理流程

```
添加设备:
1. 用户输入设备名称和坐标
2. 可选：选择设备颜色  🆕
3. 点击"添加设备"按钮
4. 系统验证输入数据
5. 验证通过后添加到设备列表
6. 立即在Matplotlib画布上显示新设备
7. 自动计算标签位置（4方向布局）  🆕
8. 保存标签位置到场景模型  🆕

修改设备:
1. 用户在设备列表中选择设备
2. 输入框自动填充设备信息
3. 用户修改信息
4. 点击"确认修改"按钮
5. 系统验证修改数据
6. 更新设备信息和画布显示
7. 重新计算该设备的标签位置  🆕

删除设备:
1. 用户在设备列表中选择设备
2. 点击"删除设备"按钮
3. 系统提示确认删除
4. 确认后从列表和画布中移除设备
5. 清除该设备的标签位置记录  🆕
```

### 4.3 标签布局流程 🆕 V2.3新增

```
自动布局:
1. 确定标签尺寸（名称+坐标多行格式）
2. 计算4个候选位置（左、上、右、下）
3. 按顺序检测每个位置的碰撞情况
   └─ 边界检查
   └─ 扇形碰撞检测
   └─ 标签重叠检测
   └─ 设备点碰撞检测
4. 选择第一个无碰撞位置
5. 保存位置到场景模型

手动调整:
1. 鼠标悬停在标签上，光标变为手形
2. 按住左键开始拖拽
3. 移动标签到目标位置
4. 释放鼠标
5. 保存新位置（标记为手动调整）
6. 后续渲染保持该位置

位置重置:
1. 右键点击画布
2. 清除所有交互元素
3. 重置所有设备标签到默认位置
4. 重新应用自动布局
```

### 4.4 双坐标系交互流程 ✨ 核心功能

```
用户位置设置:
1. 用户点击"设置用户位置"按钮
2. 系统进入用户位置设置模式
3. 用户在画布上左键单击选择位置
4. 系统在该位置显示用户图标（三层设计）  🆕
5. 绘制虚线辅助坐标轴
6. 切换到双坐标系显示模式

双坐标系测量:
1. 用户位置设置后，在画布上左键单击
2. 系统计算点击位置的双重坐标
3. 创建测量点并显示绿色标记
4. 绘制到世界原点和用户位置的连线
5. 计算双重距离和角度
6. 使用布局管理器计算信息框位置  🆕
7. 显示包含两套信息的测量框

双击扇形:
1. 用户在画布上左键双击
2. 系统检测双击事件（300ms间隔）
3. 在双击位置绘制90度扇形
4. 半透明填充显示覆盖区域
5. 注册扇形到布局管理器  🆕
6. 现有标签自动避让扇形区域  🆕

右键清除:
1. 用户右键点击画布
2. 清除所有测量点、扇形和信息框
3. 保留设备点、用户位置和双坐标系
4. 重置设备标签到默认位置  🆕
```

## 5. 技术升级成果

### 5.1 Canvas → Matplotlib迁移成果 ✨

- **代码简化**: 从1314行复杂逻辑优化
- **性能提升**: 矢量图形，无损缩放，科学计算集成
- **功能增强**: 多格式导出，扇形绘制，更强交互
- **跨平台**: 完美的Windows/macOS/Linux兼容性

### 5.2 V2.3新增功能特性

- **力导向布局算法**: FastLayoutManager实现智能标签避让
- **4方向标签布局**: 左/上/右/下，顺时针避让顺序
- **扇形斥力场**: 标签自动避开扇形区域
- **三重碰撞检测**: 扇形、标签、设备全方位检测
- **位置固定机制**: 标签位置一旦确定保持固定
- **虚线引导线**: 标签与设备间的视觉连接
- **设备自定义颜色**: 每个设备支持独立颜色设置
- **标签拖拽调整**: 手动调整标签位置

### 5.3 V2.5新增功能特性

- **背景户型图导入**: 支持PNG/JPG格式户型图作为背景参考
- **像素比例映射**: 通过"每X像素=1坐标单位"设置图片实际尺寸
- **中心对齐**: 背景图自动居中显示在坐标原点
- **透明度调节**: 滑块控制10%-100%透明度
- **显示切换**: 可随时隐藏/显示背景图
- **项目持久化**: 背景图通过Base64嵌入项目文件，确保可移植性
- **图层管理**: zorder分层确保背景图始终在最底层

### 5.4 V2.6新增功能特性

- **标签式布局**: 右侧面板改为 `ttk.Notebook` 标签式布局
- **四个功能标签页**: 坐标设置、背景设置、设备管理、系统操作
- **空间优化**: 减少垂直滚动需求，提升空间利用率

### 5.5 V2.7 Bug修复与稳定性提升 🆕

- **Headless环境兼容**: GUI测试添加display检测，CI/headless环境自动跳过
- **自动保存完整性**: 修复自动保存丢失背景图/锁定扇形/用户坐标系状态的问题
- **重置功能完整性**: 修复重置/新建项目后背景图、锁定扇形、用户坐标系状态未清除的问题
- **项目加载修复**: 修复加载项目后用户坐标系五边形不显示的问题
- **UI一致性修复**: 修复坐标设置标签页白色背景与其他标签页不一致的问题
- **状态同步修复**: 修复重置后状态标签未更新的问题

## 6. 最终验收结果 ✅

### 6.1 功能验收标准 - 全部通过

- ✅ 界面布局符合1280x800规格要求
- ✅ Matplotlib坐标系统显示正确，支持范围调整
- ✅ 设备管理功能完整（增删改查）+ 事务式操作
- ✅ 交互测量功能正常（点击、双击、右键清除）
- ✅ 多格式导出功能正常（PNG/SVG/PDF高质量输出）
- ✅ 重置功能正常 + 快捷键支持
- ✅ 智能标签布局功能正常（力导向算法）
- ✅ 标签避让功能正常（扇形、标签、设备）
- ✅ 标签拖拽调整功能正常
- ✅ 背景户型图导入功能正常 V2.5
- ✅ 背景图透明度/显示切换功能正常 V2.5
- ✅ 背景图项目持久化功能正常 V2.5
- ✅ GUI测试在headless环境下正常跳过 🆕 V2.7
- ✅ 自动保存包含完整项目状态 🆕 V2.7
- ✅ 重置后所有状态完全清空 🆕 V2.7
- ✅ 项目加载后用户坐标系正确显示 🆕 V2.7

### 6.2 性能验收标准 - 超越目标

- ✅ 启动时间<2秒 (超越3秒目标)
- ✅ 界面响应时间<50ms (超越100ms目标)
- ✅ 支持100+设备流畅显示 (矢量图形优势)
- ✅ 内存占用<150MB (Matplotlib自动优化)
- ✅ 标签布局性能提升~90% (位置缓存机制) 🆕

### 6.3 用户体验验收标准 - 优秀

- ✅ 界面美观，配色协调，Matplotlib专业绘图
- ✅ 操作直观，符合科学计算软件习惯
- ✅ 错误提示友好明确，完整中文提示
- ✅ 功能完整，超越原始需求
- ✅ 标签布局智能，多设备场景信息清晰可读 🆕

### 6.4 质量验收标准 - 卓越

- ✅ 代码结构清晰，MVC + Matplotlib架构，注释完整
- ✅ 核心功能有测试覆盖，57个测试文件（支持headless环境）
- ✅ 文档齐全，完整技术文档
- ✅ 无明显Bug，完整异常处理机制
- ✅ Headless环境测试兼容 🆕 V2.7

**最终评价**: 通过技术栈升级、V2.3智能布局功能、V2.5背景户型图功能和V2.7稳定性提升，项目已从传统GUI应用成功升级为现代科学计算应用，在功能、性能、代码质量等方面全面超越原始需求。智能标签布局功能显著提升了多设备场景下的信息可读性，背景户型图功能则让用户能够在真实户型图上直观地规划设备布局，V2.7版本的全面Bug修复确保了应用在各种环境下的可靠运行，进一步提升了工具的实用价值和稳定性。
