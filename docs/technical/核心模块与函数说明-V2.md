# 家居设备坐标工具 - 核心模块与函数说明（V2 Matplotlib 版）

## 1. 启动与控制器层

- 模块：`dev/src/main.py`  
  - `main() -> None`  
    - 输入：无（从命令行启动）。  
    - 输出：无，启动 Tk 主循环。  
    - 逻辑：创建 `tk.Tk()` 主窗口，实例化 `MatplotlibController(root)`，进入 `root.mainloop()`，并对异常/键盘中断做简单日志输出。

- 模块：`dev/src/controllers/scene_controller.py`（场景控制器）**[V2重构引入]**
  - `__init__(self, model: SceneModel, renderer: Optional['SceneRenderer'] = None) -> None` *(第33行)*  
    - 输入：场景数据模型、可选的场景渲染器。  
    - 输出：无。  
    - 逻辑：初始化场景控制器，设置双击检测参数，注册为Model的观察者，负责协调Model和Renderer之间的数据同步。

  - `set_renderer(self, renderer: 'SceneRenderer') -> None` *(第57行)*  
    - 输入：场景渲染器实例。  
    - 输出：无。  
    - 逻辑：设置或更新渲染器引用，支持延迟初始化。

  - `on_canvas_click(self, x: float, y: float, button: int, current_time: float) -> None` *(第87行)*  
    - 输入：点击坐标、按钮类型、时间戳。  
    - 输出：无。  
    - 逻辑：统一处理画布点击事件，根据时间间隔区分单击和双击，分发到对应的处理函数。

  - `_handle_left_click(self, x: float, y: float) -> None` *(第108行)*  
    - 输入：点击坐标。  
    - 输出：无。  
    - 逻辑：处理单击事件，创建或更新测量点，调用Model的set_measurement方法。

  - `_handle_double_click(self, x: float, y: float) -> None` *(第120行)*  
    - 输入：点击坐标。  
    - 输出：无。  
    - 逻辑：处理双击事件，基于当前坐标系（世界或用户）绘制90度扇形。

  - `_handle_right_click(self) -> None` *(第154行)*  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：清除测量点和扇形数据，通知Renderer更新显示。

  - `add_device(self, name: str, x: float, y: float) -> Tuple[bool, str]` *(第217行)*  
    - 输入：设备名称和坐标。  
    - 输出：成功标志和消息。  
    - 逻辑：创建Device对象并添加到Model，触发观察者通知和视图更新。

  - `update_device(self, device_id: str, name: str, x: float, y: float) -> Tuple[bool, str]` *(第235行)*  
    - 输入：设备ID、新名称、新坐标。  
    - 输出：成功标志和消息。  
    - 逻辑：更新指定设备的数据，保持ID和创建时间不变。

  - `delete_device(self, device_id: str) -> Tuple[bool, str]` *(第254行)*  
    - 输入：设备ID。  
    - 输出：成功标志和消息。  
    - 逻辑：从Model中删除设备，触发视图更新。

  - `on_label_drag(self, element_id: str, new_x: float, new_y: float) -> None` *(第276行)*  
    - 输入：元素ID、新坐标。  
    - 输出：无。  
    - 逻辑：处理标签拖动事件，更新Model中的标签位置为手动位置。

  - `reset_label_position(self, element_id: str) -> None` *(第317行)*  
    - 输入：元素ID。  
    - 输出：无。  
    - 逻辑：重置标签到自动计算位置，清除手动调整状态。

  - `export_png(self, file_path: str, dpi: int = 300) -> Tuple[bool, str]` *(第328行)*  
    - 输入：文件路径、DPI设置。  
    - 输出：成功标志和消息。  
    - 逻辑：通过Renderer导出当前场景为PNG图像。

  - `_on_model_changed(self, change_type: ChangeType, data: Any) -> None` *(第358行)*  
    - 输入：变更类型枚举、变更数据。  
    - 输出：无。  
    - 逻辑：作为观察者响应Model变化，根据变更类型选择性触发Renderer的重绘或局部更新。

- 模块：`dev/src/controllers/matplotlib_controller.py`（主控制器）
  - `__init__(self, root: tk.Tk) -> None`  
    - 输入：Tk 根窗口。  
    - 输出：无。  
    - 逻辑：构造 `DeviceManager`、`ProjectManager`、`ConfigManager`，创建左侧 `MatplotlibView` 和右侧 `InputPanel`，设置菜单栏、事件绑定、窗口关闭钩子，启动自动保存并检查是否有草稿可恢复。

  - `_bind_view_events(self) -> None`  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：将 `MatplotlibView` 的鼠标回调绑定到 `_on_canvas_click` / `_on_canvas_double_click` / `_on_canvas_right_click` / `_on_canvas_mouse_move`，将 `InputPanel` 的按钮/输入回调绑定到控制器对应的处理函数（坐标范围变更、设备增删改、导出、重置、用户坐标系切换与位置设置），并初次同步设备列表。

  - `_on_range_change(self, x_range: float, y_range: float) -> None`  
    - 输入：新的 X/Y 范围。  
    - 输出：无。  
    - 逻辑：调用 `set_coordinate_range` 更新画布范围，更新右侧状态指示器，标记项目已修改并刷新窗口标题。

  - `_on_user_coord_toggle(self, enabled: bool) -> None`  
    - 输入：是否启用用户坐标系。  
    - 输出：无。  
    - 逻辑：通知视图 `set_user_coordinate_mode(enabled)`，更新右侧状态文本，禁用时清除用户位置状态；标记项目修改。

  - `_on_user_position_set(self, x: float, y: float) -> None`  
    - 输入：用户位置坐标。  
    - 输出：无。  
    - 逻辑：调用 `MatplotlibView.set_user_position(x, y)`，更新 `InputPanel` 状态，标记项目修改。

  - `add_device(self, name: str, x: float, y: float) -> bool`  
    - 输入：设备名称和坐标。  
    - 输出：布尔，是否成功。  
    - 逻辑：创建 `Device`（内部自带验证），调用 `DeviceManager.add_device` 做数量/名称唯一/ID 检查和事务回滚；成功时标记项目被修改、更新视图设备散点图和右侧列表，失败时通过 `messagebox` 提示原因。

  - `update_device(self, device_id: str, name: str, x: float, y: float) -> bool`  
    - 输入：设备 ID、新名称、新坐标。  
    - 输出：布尔。  
    - 逻辑：构造新的 `Device`，通过 `DeviceManager.update_device` 完成唯一性验证和事务更新，保持原 ID/创建时间；成功后刷新视图和列表。

  - `delete_device(self, device_id: str) -> bool`  
    - 输入：待删除设备 ID。  
    - 输出：布尔。  
    - 逻辑：检查设备存在性，调用 `DeviceManager.delete_device` 完成事务删除并更新视图和列表。

  - `get_device_by_id(self, device_id: str) -> Device | None`  
    - 输入：设备 ID。  
    - 输出：对应的 `Device` 实例或 `None`。  
    - 逻辑：直接调用 `DeviceManager.get_device_by_id`。

  - `set_coordinate_range(self, x_range: float, y_range: float) -> None`  
    - 输入：X/Y 范围。  
    - 输出：无。  
    - 逻辑：对范围做简单数值/区间检查（0.1–50），然后调用 `MatplotlibView.set_coordinate_range` 重新绘制坐标网格与所有元素。

  - `export_png(self) -> None`  
    - 输入：无（由按钮/快捷键触发）。  
    - 输出：无。  
    - 逻辑：调起文件保存对话框生成默认文件名，调用 `MatplotlibView.export_to_png(path, dpi=300)` 导出，结果通过弹窗反馈。

  - `reset_all(self) -> None`  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：询问确认后，清空设备管理器、清除 `MatplotlibView` 中所有设备/测量/扇形/坐标信息，并重置坐标范围和输入面板。

  - `new_project(self) -> None` / `open_project(self) -> None` / `save_project(self) -> bool` / `save_project_as(self) -> bool`  
    - 输入：无，或内部弹窗获取文件路径。  
    - 输出：布尔表示保存/另存为是否成功（`open`/`new` 仅通过弹窗提示）。  
    - 逻辑：在关闭/切换项目前检查是否有未保存修改；调用 `_save_to_file` / `_load_project_file`，由 `ProjectManager` 完成 JSON 组装、验证和 I/O，并同步坐标范围、设备列表、用户坐标系和标签状态到视图/面板。

  - `import_devices_csv(self) -> None` / `export_devices_csv(self) -> None`  
    - 输入：无（文件路径由对话框取得）。  
    - 输出：无。  
    - 逻辑：通过 `ProjectManager.import_devices_from_csv` 读取设备、询问是否清空现有设备后批量加入 `DeviceManager`，或直接调用 `export_devices_to_csv` 导出当前设备列表。

  - `_start_autosave(self) -> None` / `_autosave(self) -> None` / `_check_autosave_recovery(self) -> None`  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：从 `ConfigManager` 读取自动保存开关与间隔，定时将设备 + 坐标范围 + 用户坐标体系状态写入草稿文件（`save_draft`），并在启动时检查最近草稿是否需要恢复。

  - `_on_window_closing(self) -> None`  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：在窗口关闭前检查 `ProjectManager.is_modified`，给出保存/不保存/取消选项；关闭自动保存定时器并销毁窗口。

---

## 2. 视图层：画布与右侧面板

- 模块：`dev/src/views/matplotlib_view.py`（核心绘图组件）
  - `__init__(self, parent_frame: tk.Frame) -> None`  
    - 输入：父 Tk 框架。  
    - 输出：无。  
    - 逻辑：创建 `Figure` / `Axes`，嵌入 Tk，初始化设备列表、测量点、扇形点、用户坐标状态和各种艺术家列表，创建 `FastLayoutManager` 并绑定 Matplotlib 鼠标事件。

  - `_setup_coordinate_system(self, x_range: float, y_range: float) -> None`  
    - 输入：X/Y 范围。  
    - 输出：无。  
    - 逻辑：清空坐标轴，设置对称范围和整数刻度，绘制网格、X/Y 轴和原点，统一配色与字体设置。

  - `set_coordinate_range(self, x_range: float, y_range: float) -> None`  
    - 输入：X/Y 范围。  
    - 输出：无。  
    - 逻辑：清除所有现有 artist 引用和布局缓存，重新初始化布局管理器和坐标系，重新绘制设备、测量、扇形与用户坐标叠加层，并刷新画布。

  - `update_devices(self, devices: List[Device]) -> None` / `get_devices(self) -> List[Device]`  
    - 输入：设备列表；输出：当前设备列表副本。  
    - 逻辑：刷新内部设备缓存，调用 `_draw_devices` 将设备以散点 + 标签形式绘制；标签位置主要通过 `FastLayoutManager.calculate_optimal_position` 做碰撞和扇形避让。

  - `_draw_measurement(self) -> None` / `_draw_sector(self) -> None`  
    - 输入：无（使用内部的 `measurement_point` 和 `sector_point` 状态）。  
    - 输出：无。  
    - 逻辑：根据当前坐标模式绘制测量点、到原点/用户的连线与描述信息框；双击时按“连线±45°”规则以原点或用户位置为中心计算 90° 扇形并绘制填充和边界。

  - `set_click_callback(self, callback: Callable[[float, float], None]) -> None` 及  
    `set_double_click_callback(self, callback: Callable[[float, float], None]) -> None` /  
    `set_right_click_callback(self, callback: Callable[[], None]) -> None` /  
    `set_mouse_move_callback(self, callback: Callable[[float, float], None]) -> None`  
    - 输入：回调函数。  
    - 输出：无。  
    - 逻辑：将 Matplotlib 的鼠标事件转发到控制器，控制器再负责业务处理（如更新 `MeasurementPoint` 或清空测量）。

  - `export_to_png(self, file_path: str, dpi: int = 300) -> bool`  
    - 输入：文件路径和 DPI。  
    - 输出：布尔，是否成功。  
    - 逻辑：暂时提高 Figure DPI，通过 `figure.savefig` 保存 PNG，带背景色和 `bbox_inches='tight'`，完成后恢复原 DPI。

  - `clear_all(self) -> None`  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：清空设备、测量点和扇形状态，清除所有 artist 和文本对象，重新绘制基础坐标系，并在启用用户坐标系时重画叠加层。

  - `set_user_coordinate_mode(self, enabled: bool) -> None` / `set_user_position(self, x: float, y: float) -> None`  
    - 输入：开关状态或用户坐标。  
    - 输出：无。  
    - 逻辑：切换用户坐标网格/轴线/标记的显示，并调用 `_update_measurement_reference` 更新当前测量点所依赖的参考坐标系，保持信息框内容一致。

  - `_draw_coordinate_info(self, x: float, y: float) -> None`  
    - 输入：当前鼠标位置。  
    - 输出：无。  
    - 逻辑：在鼠标悬停时生成世界坐标 /（可选）用户相对坐标 + 距离 + 角度文本，利用 `FastLayoutManager` 给坐标信息框选一个不会遮挡主要元素的自动位置。

- 模块：`dev/src/views/input_panel.py`（右侧操作面板）
  - `__init__(self, parent_frame: tk.Frame, controller=None) -> None`  
    - 输入：父框架、可选控制器引用。  
    - 输出：无。  
    - 逻辑：构建滚动区域，创建坐标范围设置、用户坐标设置、设备列表 `Treeview`、输入框、按钮和状态指示器等子区域，并绑定本地事件到内部处理函数。

  - `_on_range_apply(self) -> None`  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：解析 X/Y 范围输入，验证后通过 `on_range_change_callback(x_range, y_range)` 通知控制器更新坐标系。

  - `_on_user_coord_toggle(self) -> None` / `_on_user_position_set(self) -> None`  
    - 输入：无（从控件状态读取）。  
    - 输出：无。  
    - 逻辑：切换用户坐标系开关并更新状态标签；在设置用户位置时校验坐标在当前范围内，调用控制器的用户坐标事件回调，并刷新“当前状态”显示。

  - 设备相关：  
    - `_on_device_add(self) -> None` / `_on_device_update(self) -> None` / `_on_device_delete(self) -> None`  
      - 输入：无（从输入框/选中行读取）。  
      - 输出：无。  
      - 逻辑：读取名称和坐标，创建 `Device` 或查找选中设备后，通过对应回调交给控制器执行实际操作，然后刷新 `Treeview`。

  - 公共接口（供控制器调用）：  
    - `set_range_change_callback(self, callback)` / `set_device_add_callback(self, callback)` /  
      `set_device_update_callback(self, callback)` / `set_device_delete_callback(self, callback)` /  
      `set_export_callback(self, callback)` / `set_reset_callback(self, callback)`  
    - `set_user_coord_toggle_callback(self, callback)` / `set_user_position_set_callback(self, callback)`  
      - 输入：回调函数。  
      - 输出：无。  
      - 逻辑：注入控制器提供的回调，使面板上的操作能够驱动控制器。

    - `update_devices(self, devices: List[Device]) -> None`  
      - 输入：设备列表。  
      - 输出：无。  
      - 逻辑：刷新内部缓存和 `Treeview` 展示，重置输入表单与选择状态。

    - `update_coordinate_mode_status(self, user_coord_enabled: bool) -> None` /  
      `update_user_position_status(self, user_position: Optional[tuple]) -> None`  
      - 输入：当前模式开关/用户位置。  
      - 输出：无。  
      - 逻辑：更新“当前状态”区域的文字和颜色，给用户明确的模式反馈。

---

## 3. 数据模型与管理

- 模块：`dev/src/models/scene_model.py`（场景数据模型）**[V2重构引入]**
  - `SceneModel.__init__(self) -> None` *(第183行)*  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：初始化场景的单一数据源（Single Source of Truth），包含设备列表、坐标范围、用户坐标系、测量点、扇形、标签位置等所有场景状态，并初始化观察者列表和修改标记。

  - `set_user_position(self, x: float, y: float) -> bool` *(第225行)*  
    - 输入：用户位置坐标。  
    - 输出：布尔值表示是否成功。  
    - 逻辑：设置用户坐标系原点，创建用户坐标框架，并更新测量点的参考数据，通知观察者USER_POSITION_SET事件。

  - `clear_user_position(self) -> None` *(第251行)*  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：清除用户坐标系，恢复到世界坐标系，更新测量点参考，通知观察者USER_POSITION_CLEARED事件。

  - `set_coordinate_range(self, x_range: float, y_range: float) -> bool` *(第285行)*  
    - 输入：X/Y坐标范围。  
    - 输出：布尔值表示是否成功。  
    - 逻辑：更新坐标范围，进行有效性验证（0.1-50），通知观察者COORD_RANGE_CHANGED事件。

  - `add_device(self, device: Device) -> Tuple[bool, str]` *(第356行)*  
    - 输入：设备对象。  
    - 输出：成功标志和消息。  
    - 逻辑：执行事务性设备添加，包含数量上限（100个）、名称唯一性、ID唯一性检查，失败时自动回滚，成功后通知观察者DEVICE_ADDED事件。

  - `update_device(self, device_id: str, new_data: Device) -> Tuple[bool, str]` *(第385行)*  
    - 输入：设备ID、新设备数据。  
    - 输出：成功标志和消息。  
    - 逻辑：事务性更新设备数据，验证新名称唯一性（排除自身），保持原有ID和创建时间，失败时回滚，成功后通知观察者DEVICE_UPDATED事件。

  - `remove_device(self, device_id: str) -> Tuple[bool, str]` *(第434行)*  
    - 输入：设备ID。  
    - 输出：成功标志和消息。  
    - 逻辑：事务性删除设备，同时清除该设备相关的标签位置数据，通知观察者DEVICE_REMOVED事件。

  - `set_measurement(self, x: float, y: float) -> None` *(第486行)*  
    - 输入：测量点坐标。  
    - 输出：无。  
    - 逻辑：创建测量点对象，根据当前坐标系（世界或用户）设置参考点，通知观察者MEASUREMENT_SET事件。

  - `add_sector(self, center_x: float, center_y: float, radius: float, start_angle_deg: float, end_angle_deg: float) -> None` *(第549行)*  
    - 输入：扇形参数（中心、半径、起止角度）。  
    - 输出：无。  
    - 逻辑：创建扇形数据对象添加到场景，通知观察者SECTOR_ADDED事件，支持多扇形叠加显示。

  - `set_label_position(self, element_id: str, x: float, y: float, is_manual: bool = True) -> None` *(第599行)*  
    - 输入：元素ID、标签坐标、是否为手动位置。  
    - 输出：无。  
    - 逻辑：设置或更新标签位置，区分手动拖动和自动计算，通知观察者LABEL_POSITION_CHANGED事件。

  - `get_manual_label_positions(self) -> Dict[str, LabelPosition]` *(第648行)*  
    - 输入：无。  
    - 输出：手动调整的标签位置字典。  
    - 逻辑：筛选并返回所有手动设置的标签位置，用于项目保存时持久化用户调整。

  - `reset_label_to_auto(self, element_id: str) -> None` *(第657行)*  
    - 输入：元素ID。  
    - 输出：无。  
    - 逻辑：将指定标签重置为自动计算位置，清除手动调整状态。

  - `add_observer(self, callback: Callable[[ChangeType, Any], None]) -> None` *(第686行)*  
    - 输入：观察者回调函数。  
    - 输出：无。  
    - 逻辑：注册观察者，当Model数据变化时自动调用回调函数，实现观察者模式的数据驱动更新。

  - `_notify_observers(self, change_type: ChangeType, data: Any = None) -> None` *(第706行)*  
    - 输入：变更类型、变更数据。  
    - 输出：无。  
    - 逻辑：遍历所有观察者并通知数据变化，支持细粒度的变更类型识别。

  - `to_dict(self) -> Dict[str, Any]` *(第745行)* / `from_dict(self, data: Dict[str, Any]) -> None` *(第777行)*  
    - 输入/输出：场景数据字典。  
    - 逻辑：实现场景状态的序列化和反序列化，支持项目保存/加载，包含设备、坐标、用户坐标系、标签位置等所有状态。

- 模块：`dev/src/models/device_model.py`
  - `Device.__init__(self, name: str, x: float, y: float, device_id: Optional[str] = None)`  
    - 输入：设备名、坐标、可选 ID。  
    - 输出：`Device` 实例。  
    - 逻辑：通过 `Validator` 对名称和坐标做严格验证，生成或使用给定的 UUID，记录创建时间，并初始化标签位置状态字段。

  - `to_dict(self) -> Dict[str, Any]` / `@classmethod from_dict(cls, data: Dict[str, Any]) -> Device`  
    - 输入：对象或字典。  
    - 输出：字典或 `Device`。  
    - 逻辑：在项目保存/加载时，将设备在 Python 对象和 JSON 结构间转换，同时保留创建时间和标签位置状态。

  - `update_position(self, x: float, y: float) -> None` *(第89行)*  
    - 输入：新的X轴坐标、Y轴坐标。  
    - 输出：无。  
    - 逻辑：更新设备位置并重新验证，用于设备位置修改操作。

  - `update_name(self, name: str) -> None` *(第101行)*  
    - 输入：新的设备名称。  
    - 输出：无。  
    - 逻辑：更新设备名称并重新验证，用于设备重命名操作。

  - `distance_to(self, other: Device) -> float` *(第174行)* / `distance_to_origin(self) -> float` *(第186行)*  
    - 输入：另一个设备或无。  
    - 输出：距离数值。  
    - 逻辑：计算两点或到原点的欧几里得距离，供分析或测试使用。

  - `__str__(self) -> str` *(第195行)*  
    - 输入：无。  
    - 输出：简短字符串表示。  
    - 逻辑：返回设备的简要描述，格式为 `Device(name='...', x=..., y=...)`。

  - `__repr__(self) -> str` *(第199行)*  
    - 输入：无。  
    - 输出：详细字符串表示。  
    - 逻辑：返回设备的完整描述，包含ID和创建时间，便于调试和日志记录。

  - `__eq__(self, other) -> bool` *(第204行)*  
    - 输入：待比较的对象。  
    - 输出：布尔值。  
    - 逻辑：基于设备ID判断两个设备对象是否相等，用于集合操作和查找。

  - `set_info_position(self, position: str, is_forced: bool = False) -> None` *(第210行)* **[V2.1新增]**  
    - 输入：信息框位置字符串（如"top_left"）、是否为强制避让位置。  
    - 输出：无。  
    - 逻辑：设置设备信息框的显示位置，首次非强制设置会记录为默认位置，实现标签位置持久化功能。

  - `reset_info_position_to_default(self) -> None` *(第224行)* **[V2.1新增]**  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：将信息框位置重置到用户首次确定的默认位置，清除强制避让标记。

  - `get_info_position_status(self) -> Dict[str, Any]` *(第230行)* **[V2.1新增]**  
    - 输入：无。  
    - 输出：包含当前位置、默认位置和强制标记的字典。  
    - 逻辑：获取信息框位置的完整状态信息，供视图层和项目保存使用。

- 模块：`dev/src/models/measurement_model.py`
  - `MeasurementPoint.__init__(self, x: float, y: float, reference_point: Optional[Tuple[float, float]] = None)`  
    - 输入：测量点坐标和可选参考点。  
    - 输出：`MeasurementPoint` 实例。  
    - 逻辑：记录点坐标和参考点（默认原点），立即计算到原点/参考点的距离和与对应坐标轴最小夹角，并做合法性验证。

  - `update_position(self, x: float, y: float) -> None` / `update_reference_point(self, rx: float, ry: float) -> None`  
    - 输入：新的点坐标或参考点。  
    - 输出：无。  
    - 逻辑：更新内部状态并重新计算所有相关几何量，保证视图展示的距离/角度信息始终一致。

  - `is_in_quadrant(self, quadrant: int) -> bool` *(第208行)*  
    - 输入：象限编号（1-4）。  
    - 输出：布尔值。  
    - 逻辑：判断测量点是否在指定象限内，用于基于位置的布局和显示逻辑。

  - `get_formatted_info(self, decimal_places: int = 3, use_reference: bool = False) -> dict` *(第229行)*  
    - 输入：小数位数、是否采用参考坐标系。  
    - 输出：包含格式化信息的字典（coordinates、distance、angle）。  
    - 逻辑：返回格式化的测量信息字典，根据坐标模式选择世界或用户坐标系数据，支持双坐标系显示。

  - `get_info_lines(self, decimal_places: int = 3, use_reference: bool = False) -> list[str]` *(第256行)*  
    - 输入：小数位数、是否采用参考坐标系。  
    - 输出：三行文本（坐标、距离、角度）。  
    - 逻辑：按当前坐标模式生成供标签使用的文本行，`MatplotlibView` 直接将其拼装到测量信息框中。

  - `__str__(self) -> str` *(第297行)*  
    - 输入：无。  
    - 输出：简短字符串表示。  
    - 逻辑：返回测量点的简要描述，便于调试输出。

  - `__repr__(self) -> str` *(第301行)*  
    - 输入：无。  
    - 输出：详细字符串表示。  
    - 逻辑：返回测量点的完整描述，包含坐标和参考点信息。

  - `__eq__(self, other) -> bool` *(第307行)*  
    - 输入：待比较的对象。  
    - 输出：布尔值。  
    - 逻辑：基于坐标值判断两个测量点对象是否相等，用于测试和比较。

- 模块：`dev/src/models/device_manager.py`
  - `DeviceManager.__init__(self) -> None`  
    - 输入：无。  
    - 输出：无。  
    - 逻辑：初始化内部设备列表和观察者列表，并创建默认设备样例（“7寸屏”、“4寸屏”）。

  - `add_device(self, device: Device) -> tuple[bool, str]` /  
    `update_device(self, device_id: str, new_device: Device) -> tuple[bool, str]` /  
    `delete_device(self, device_id: str) -> tuple[bool, str]` /  
    `clear_all_devices(self) -> tuple[bool, str]`  
    - 输入：设备对象或设备 ID。  
    - 输出：成功标志和消息。  
    - 逻辑：以事务方式操作内部设备列表，失败时通过备份回滚；包含数量上限、名称唯一、ID 唯一和存在性检查，并在成功后通知所有观察者。

  - `get_devices(self) -> List[Device]` / `get_device_by_id(self, device_id: str) -> Optional[Device]` /  
    `get_device_count(self) -> int`  
    - 输入：可选设备 ID。  
    - 输出：设备列表/单个设备/数量。  
    - 逻辑：提供只读视图以避免外部直接修改内部列表。

  - `validate_device_operation(self, operation: str, device: Device, device_id: Optional[str] = None) -> tuple[bool, str]`  
    - 输入：操作类型、设备对象和可选 ID。  
    - 输出：验证结果及消息。  
    - 逻辑：执行与添加/更新/删除相同的合法性检查但不修改状态，用于预检或表单校验。

- 模块：`dev/src/models/project_manager.py`
  - `save_project(self, file_path: str, devices: List[Device], coordinate_settings: Dict[str, float], user_coord_settings: Optional[Dict[str, Any]] = None, project_info: Optional[Dict[str, str]] = None, label_positions: Optional[Dict[str, Dict[str, Any]]] = None) -> Tuple[bool, str]`  
    - 输入：文件路径、设备列表、坐标范围、用户坐标系设置、项目信息、标签位置。  
    - 输出：成功标志与消息。  
    - 逻辑：调用 `_build_project_data` 组装项目 JSON，使用 `_validate_project_data` 做结构性检查，再写入文件并更新当前项目路径/名称/修改状态。

  - `save_draft(...) -> Tuple[bool, str]`  
    - 输入同上。  
    - 输出：成功标志与消息。  
    - 逻辑：用于自动保存草稿，与 `save_project` 类似但不会改动当前项目状态。

  - `load_project(self, file_path: str) -> Tuple[bool, str, Optional[Dict[str, Any]]]`  
    - 输入：`.apc` 文件路径。  
    - 输出：成功标志、消息和项目数据字典（含 `devices_parsed` 列表）。  
    - 逻辑：读取 JSON，验证结构，解析设备为 `Device` 实例，并记录标签位置信息；成功后更新当前项目路径和名称。

  - `export_devices_to_csv(self, file_path: str, devices: List[Device]) -> Tuple[bool, str]` /  
    `import_devices_from_csv(self, file_path: str) -> Tuple[bool, str, List[Device]]`  
    - 输入：文件路径和设备列表。  
    - 输出：成功标志、消息和导入的设备列表（导入时）。  
    - 逻辑：对 CSV 文件做存在性和行级合法性检查，将每行转换为 `Device`；导出时写入 UTF-8-sig 编码 CSV 并保留三列（名称、X、Y）。

- 模块：`dev/src/models/config_manager.py`
  - `get_recent_files(self) -> List[str]` / `add_recent_file(self, file_path: str) -> bool` /  
    `clear_recent_files(self) -> bool`  
    - 输入：可选文件路径。  
    - 输出：文件列表或布尔。  
    - 逻辑：在配置 JSON 中维护最近打开的项目文件列表，自动过滤已不存在的路径。

  - `is_autosave_enabled(self) -> bool` / `get_autosave_interval(self) -> int` / `set_autosave_interval(self, interval: int) -> bool`  
    - 输入：可选间隔秒数。  
    - 输出：布尔或整数。  
    - 逻辑：提供自动保存开关和周期控制，供控制器读取和修改。

  - `get_autosave_file_path(self) -> Path` / `get_latest_autosave_file(self) -> Optional[Path]` /  
    `clean_old_autosave_files(self, keep_count: int = 5) -> int`  
    - 输入：保留文件数。  
    - 输出：自动保存路径、最新草稿路径或删除数量。  
    - 逻辑：在配置目录下管理 `autosave` 子目录，生成时间戳命名的草稿文件并定期清理旧文件。

---

## 4. 计算与布局工具

- 模块：`dev/src/utils/calculation.py` (`Calculator`)
  - `calculate_distance(x1, y1, x2, y2) -> float` / `calculate_distance_to_origin(x, y) -> float`  
    - 输入：两点或一个点。  
    - 输出：欧几里得距离。  
    - 逻辑：基本距离计算，供布局和扇形逻辑复用。

  - `calculate_min_angle_to_axis(x, y) -> float`  
    - 输入：一点坐标。  
    - 输出：与 X/Y 轴最小夹角（0–90°）。  
    - 逻辑：分别计算与 X、Y 轴夹角后取较小值，匹配 HTML 版本的定义。

  - `calculate_angle_between_points(x1, y1, x2, y2) -> float`  
    - 输入：起点和终点。  
    - 输出：从 X 轴正方向逆时针的 0–360° 角度。  
    - 逻辑：用 `atan2` 计算方向角并标准化到 [0,360)。

  - `calculate_sector_bounding_box(center_x, center_y, radius, start_angle_deg, end_angle_deg) -> (min_x, min_y, max_x, max_y)`  
    - 输入：扇形参数。  
    - 输出：外接矩形。  
    - 逻辑：考虑扇形端点和 0/90/180/270 四个关键方向，获取扇形覆盖的最小边界框。

  - `point_in_sector(...) -> bool` / `sector_rectangle_overlap(...) -> float`  
    - 输入：点或矩形与扇形的参数。  
    - 输出：是否在扇形内或重叠比例（0–1）。  
    - 逻辑：用角度归一化和半径检查判断点/矩形是否与扇形重叠，辅助布局算法避开扇形区域。

- 模块：`dev/src/utils/fast_layout.py` (`FastLayoutManager` 等)
  - `FastLayoutManager.__init__(self, canvas_bounds: Tuple[float, float, float, float])`  
    - 输入：画布边界。  
    - 输出：无。  
    - 逻辑：设置布局元素列表、扇形斥力场列表和缓存，配置信息框尺寸及 12 方向约束参数。

  - `add_element(self, element: LayoutElement) -> None` / `clear_elements(self) -> None` /  
    `clear_dynamic_elements(self) -> None`  
    - 输入：布局元素或无。  
    - 输出：无。  
    - 逻辑：维护所有需要参与布局计算的元素（设备标签、测量标签、扇形、坐标信息框等），区分静态障碍物和动态元素。

  - `add_sector_region(self, center_x, center_y, radius, start_angle_deg, end_angle_deg) -> None`  
    - 输入：扇形参数。  
    - 输出：无。  
    - 逻辑：将扇形封装为 `SectorRegion` 加入斥力场列表，供布局算法在计算标签位置时施加强排斥。

  - `calculate_device_label_position(self, anchor_x: float, anchor_y: float, element_id: str = "") -> (x, y)`  
    - 输入：设备点坐标和元素 ID。  
    - 输出：标签中心位置。  
    - 逻辑：以设备为圆心在 12 个离散方向上生成候选点，基于边界、扇形重叠、与其他标签重叠和距离评分选择最佳方案，满足“最近顶点距离不超过 3”以及“最近顶点在 12 方向之一”的约束。

  - `calculate_optimal_position(self, anchor_x, anchor_y, element_type: ElementType, element_id: str = "", preferred_offset: Tuple[float, float] = None) -> (x, y)`  
    - 输入：锚点坐标、元素类型/ID、可选偏移。  
    - 输出：元素中心位置。  
    - 逻辑：设备标签使用 12 方向约束，其他标签使用预设偏移候选 + 扇形避让的评分函数，在不超出画布边界的前提下尽量减少重叠并靠近锚点；结果做缓存提高性能。

  - `compute_layout(self, iterations: int = 80) -> None`  
    - 输入：迭代次数。  
    - 输出：无。  
    - 逻辑：对所有可移动元素运行力导向 + 模拟退火算法，综合标签间排斥、扇形斥力、锚点吸引和随机扰动，迭代出较好的全局布局。

- 模块：`dev/src/utils/validation.py` (`Validator`)
  - `validate_device_name(name) -> (bool, str)` / `validate_coordinate_value(value) -> (bool, str)` /  
    `validate_coordinate_range(range_value) -> (bool, str)` / `validate_coordinate_in_range(x, y, x_range, y_range) -> (bool, str)`  
    - 输入：名称/数值/坐标与范围。  
    - 输出：是否合法及错误信息。  
    - 逻辑：统一处理设备名长度、坐标是否为有效数字、范围区间及坐标是否落在当前显示范围等约束。

  - `validate_device_name_uniqueness(name: str, existing_names: List[str], exclude_name: Optional[str] = None) -> (bool, str)`  
    - 输入：新名称、现有名称列表、可选排除名称。  
    - 输出：唯一性检查结果。  
    - 逻辑：忽略大小写检查重复，供 `DeviceManager` 添加/更新时使用。

  - `validate_file_path(file_path: str) -> (bool, str)`  
    - 输入：目标 PNG 路径。  
    - 输出：合法性及错误信息。  
    - 逻辑：检查路径非空、文件名不含非法字符且扩展名为 `.png`，用于导出前验证。

---

## 5. 标签布局服务（备用/扩展）

- 模块：`dev/src/services/label_placer.py` (`LabelPlacer`)
  - `calculate_positions(self, devices: List[DeviceAnchor], sectors: List[SectorObstacle], coord_range: Tuple[float, float], existing_manual: Dict[str, LabelPosition] = None) -> Dict[str, LabelPosition>`  
    - 输入：设备锚点列表、扇形列表、坐标范围和已存在的手动标签位置。  
    - 输出：设备元素 ID 到标签位置的映射。  
    - 逻辑：按设备 ID 排序，针对每个设备按 8 个优先方向尝试标签位置，利用 `CollisionDetector` 和扇形信息过滤非法位置，同时保留用户手动调整过的位置。

  - `calculate_single_position(...) -> LabelPosition`  
    - 输入：单个锚点、标签类型、扇形、已放置标签和坐标范围。  
    - 输出：单个标签位置。  
    - 逻辑：用于增量布置新标签，与批量算法相同规则但只对一个元素求解。

- 模块：`dev/src/services/collision_detector.py` (`CollisionDetector`)
  - `boxes_overlap(box1, box2, margin: float = 0.0) -> bool` / `overlaps_any(box, boxes, margin: float = 0.0) -> bool`  
    - 输入：边界框及可选间距。  
    - 输出：是否碰撞。  
    - 逻辑：判断两个矩形或矩形与列表中任意矩形在给定 `margin` 下是否重叠。

  - `is_within_bounds(box, bounds, margin: float = 0.0) -> bool`  
    - 输入：边界框和画布边界。  
    - 输出：是否完全在范围内。  
    - 逻辑：用于保证标签不会超出画布边界。

  - `point_in_sector(...) -> bool` / `box_intersects_sector(...) -> bool`  
    - 输入：点或边界框与扇形信息。  
    - 输出：是否在扇形内或有交集。  
    - 逻辑：为标签布局避开扇形提供几何判定。

  - `distance_between_boxes(box1, box2) -> float`  
    - 输入：两个边界框。  
    - 输出：最短距离（重叠时为负重叠深度）。  
    - 逻辑：用于衡量标签间间距，便于布局评分或优化。

