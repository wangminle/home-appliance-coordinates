# 标签避让算法方案调研报告

针对“家居设备距离角度绘制小工具”中设备点、测量点、用户位置及扇形区域的标签避让需求，经过对现有代码的分析和GitHub/Web方案的检索，整理以下几种主流且高效的解决方案。

## 1. 现状分析

目前项目中已经实现了两种避让机制：

1. **`FastLayoutManager` (自定义)**: 一个基于“力导向”思想的简化版布局管理器。它定义了排斥力（标签之间）和吸引力（标签与锚点），通过迭代更新位置。
    * *优点*: 性能好，完全可控，针对性强。
    * *缺点*: 容易陷入局部最优解（即标签“卡”在某个位置动不了，但其实有更好的位置），缺乏全局搜索能力。
2. **`adjustText` (第三方库)**: 一个基于模拟退火思想的Matplotlib专用库。
    * *优点*: 算法成熟，能处理复杂场景。
    * *缺点*: 性能开销大，在元素较多时会有明显的卡顿。

## 2. 推荐参考方案

### 方案一：模拟退火算法 (Simulated Annealing) —— GIS地图领域的黄金标准

这是目前地图标注（Label Placement）领域最常用的算法，也是`adjustText`的核心思想，但在自定义实现中可以做得更轻量。

* **核心原理**:
  * 将标签位置视为一个“能量系统”，重叠面积越大、离锚点越远，能量越高。
  * 系统有一个“温度”参数，随着迭代逐渐降低。
  * 在高温时，系统允许标签“大幅度跳动”甚至接受比当前更差的位置（为了跳出局部陷阱）。
  * 随着温度降低，标签逐渐稳定在能量最低（效果最好）的位置。
* **GitHub 参考**:
  * **[dymo-label-placement](https://github.com/geoiq/dymo)**: 一个经典的Python实现，专门用于地图标签避让。它展示了如何定义“能量函数”和“冷却计划”。
* **对本项目的建议**:
  * 目前的 `FastLayoutManager` 只有“下山”的能力（贪心算法/力导向），没有“爬山”的能力（跳出局部最优）。
  * **改进建议**: 在 `FastLayoutManager` 中引入“温度”概念。在计算初期，允许标签随机尝试较远的位置，即使那个位置暂时看起来评分不高。这能有效解决“标签被扇形卡住”的问题。

### 方案二：力导向布局 (Force-Directed Layout) —— D3.js 的经典方案

Web前端可视化领域（如D3.js）处理节点避让的标准方案。

* **核心原理**:
  * **电荷力 (Charge)**: 所有标签互斥（像带同种电荷的粒子），防止重叠。
  * **连接力 (Link)**: 标签被“弹簧”拉向其对应的设备点（锚点）。
  * **碰撞力 (Collision)**: 定义硬边界，绝对禁止重叠。
* **GitHub 参考**:
  * **[d3-force](https://github.com/d3/d3-force)**: 虽然是JavaScript库，但其物理模型设计非常完美，值得参考。
  * **[fa2 (ForceAtlas2)](https://github.com/bhargavchippada/forceatlas2)**: Python版本的力导向布局，常用于网络图，但原理通用。
* **对本项目的建议**:
  * 目前的 `FastLayoutManager` 已经有了雏形，但物理模型比较简单。
  * **改进建议**: 引入“碰撞检测圆”或“碰撞检测框”作为刚体，而不仅仅是中心点受力。特别是对于**扇形区域**，可以将其建模为一个巨大的“斥力场”，任何标签进入该区域都会受到巨大的推力被弹开。

### 方案三：候选位置评估法 (Candidate Positions) —— 简单高效

这是许多实时导航软件（如高德/谷歌地图）在端侧渲染时采用的方案。

* **核心原理**:
  * 不让标签随意移动，而是为每个设备点预设 8 个候选位置（上、下、左、右、左上、左下、右上、右下）。
  * 按优先级（如：右上 > 右下 > ...）依次尝试。
  * 如果位置1有冲突，就试位置2，直到找到无冲突位置。
* **GitHub 参考**:
  * 许多轻量级图表库（如Chart.js）的标签插件常采用此策略。
* **对本项目的建议**:
  * 目前的 `FastLayoutManager` 似乎混合了这种思想（`primary_offsets`）。
  * **改进建议**: 可以将其作为“第一阶段”。先快速尝试8个点，如果都冲突，再启动“力导向”或“模拟退火”进行微调。

## 3. 综合建议

考虑到您已经有了 `FastLayoutManager`，**最性价比的方案是“增强现有的力导向算法”**，具体措施：

1. **引入“扇形斥力场”**: 目前扇形可能只是被视为一个静态边界框。建议计算标签中心到扇形圆心的距离和角度，如果在扇形范围内，施加一个沿径向向外的强斥力。
2. **增加“扰动”机制**: 在迭代初期加入随机微小的位移（模拟退火的简化版），防止标签在两个重叠位置之间反复横跳（震荡）。
3. **分层计算**:
    * 第1轮：仅计算设备标签避让。
    * 第2轮：固定设备标签，计算测量线标签避让。
    * 第3轮：固定前两者，计算用户位置标签。
    这样可以保证重要信息的稳定性。

如果您希望我为您实现上述改进中的任何一项（例如：为 `FastLayoutManager` 添加扇形斥力场），请随时告知。
