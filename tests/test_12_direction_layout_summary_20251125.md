# 12方向约束布局功能测试总结

**测试日期**: 2025-11-25  
**测试人员**: AI Assistant  
**功能模块**: `dev/src/utils/fast_layout.py`, `dev/src/views/matplotlib_view.py`

---

## 一、功能需求

### 1.1 需求描述

设备标记点配套的标签位置需要满足以下约束：

1. **12方向约束**: 标签只能出现在以设备标记点为圆心的12个方向上（每30°一个方向：0°, 30°, 60°, 90°, 120°, 150°, 180°, 210°, 240°, 270°, 300°, 330°）

2. **顶点位置约束**: 标签的四个顶点中，离设备标记点最近的那个顶点必须位于这12个方向之一

3. **距离约束**: 最近顶点到设备标记点的距离不能大于3

4. **碰撞避让**: 当与扇形区域或其他标签碰撞时，需要按以上原则重新选择不碰撞的位置

### 1.2 技术方案

- 新增 `_generate_12_direction_candidates()` 方法生成12方向候选位置
- 新增 `_get_corner_offset_for_direction()` 计算标签中心相对于最近顶点的偏移
- 新增 `_get_nearest_corner_distance()` 计算最近顶点距离
- 新增 `_is_corner_on_12_directions()` 验证顶点是否在12方向上
- 新增 `calculate_device_label_position()` 作为设备标签专用位置计算方法
- 修改 `calculate_optimal_position()` 对设备标签自动使用12方向约束

---

## 二、测试结果

### 2.1 单元测试

| 测试用例 | 测试内容 | 结果 |
|---------|---------|------|
| test_12_direction_generation | 验证生成12个方向的候选位置 | ✅ 通过 |
| test_corner_distance_constraint | 验证距离约束（≤3） | ✅ 通过 |
| test_corner_on_12_directions | 验证顶点在12方向上 | ✅ 通过 |
| test_device_label_position | 综合位置计算测试 | ✅ 通过 |
| test_sector_avoidance | 扇形区域避让测试 | ✅ 通过 |
| test_label_collision_avoidance | 标签碰撞避让测试 | ✅ 通过 |

**总计**: 6/6 测试通过 (100%)

### 2.2 测试详情

#### 12方向候选位置生成
- 生成了 **96个** 候选位置（12方向 × 8个距离级别）
- 覆盖了所有 **12个方向**
- 距离级别: 0.8, 1.0, 1.2, 1.5, 1.8, 2.0, 2.5, 2.9

#### 各方向第一个候选位置示例
```
方向   0°: 标签中心 (1.80, 0.40)
方向  30°: 标签中心 (1.69, 0.80)
方向  60°: 标签中心 (1.40, 1.09)
方向  90°: 标签中心 (1.00, 1.20)
方向 120°: 标签中心 (-1.40, 1.09)
方向 150°: 标签中心 (-1.69, 0.80)
方向 180°: 标签中心 (-1.80, 0.40)
方向 210°: 标签中心 (-1.69, -0.80)
方向 240°: 标签中心 (-1.40, -1.09)
方向 270°: 标签中心 (-1.00, -1.20)
方向 300°: 标签中心 (1.40, -1.09)
方向 330°: 标签中心 (1.69, -0.80)
```

#### 设备标签位置计算结果
| 设备名称 | 设备位置 | 标签中心 | 最近顶点 | 顶点距离 | 顶点角度 |
|---------|---------|---------|---------|---------|---------|
| 原点设备 | (0, 0) | (1.00, 1.20) | (0.00, 0.80) | 0.80 | 90.0° |
| 右上设备 | (5, 5) | (4.00, 3.80) | (5.00, 4.20) | 0.80 | 270.0° |
| 左上设备 | (-5, 5) | (-6.00, 3.80) | (-5.00, 4.20) | 0.80 | 270.0° |
| 右下设备 | (5, -5) | (6.00, -3.80) | (5.00, -4.20) | 0.80 | 90.0° |
| 左下设备 | (-5, -5) | (-4.00, -3.80) | (-5.00, -4.20) | 0.80 | 90.0° |

---

## 三、修改文件清单

### 3.1 核心代码修改

| 文件 | 修改内容 |
|-----|---------|
| `dev/src/utils/fast_layout.py` | 新增12方向约束布局系统（约200行新代码） |
| `dev/src/views/matplotlib_view.py` | 更新设备标签绘制逻辑，注册元素到布局管理器 |

### 3.2 新增测试文件

| 文件 | 说明 |
|-----|-----|
| `tests/test_12_direction_layout.py` | 12方向约束布局单元测试脚本 |
| `tests/test_12_direction_layout_summary_20251125.md` | 本测试总结文档 |

---

## 四、关键算法说明

### 4.1 候选位置生成算法

```python
def _generate_12_direction_candidates(anchor_x, anchor_y, box_width, box_height):
    """
    对于12个方向（0°, 30°, 60°, ...）:
        计算方向向量 (dir_x, dir_y)
        确定该方向对应的标签顶点偏移
        对于每个距离级别（0.8, 1.0, 1.2, ...）:
            计算顶点位置 = 设备点 + 方向向量 × 距离
            计算标签中心 = 顶点位置 + 偏移量
            添加到候选列表
    """
```

### 4.2 顶点偏移计算逻辑

```python
def _get_corner_offset_for_direction(dir_x, dir_y, box_width, box_height):
    """
    根据方向确定哪个顶点应该是最近顶点：
    - 方向指向右 → 最近顶点在左侧 → 中心在顶点右边
    - 方向指向左 → 最近顶点在右侧 → 中心在顶点左边
    - 方向指向上 → 最近顶点在下方 → 中心在顶点上方
    - 方向指向下 → 最近顶点在上方 → 中心在顶点下方
    """
```

---

## 五、结论

✅ **12方向约束布局功能已成功实现**

- 设备标签位置现在严格遵循12方向约束（每30°一个方向）
- 标签最近顶点到设备点的距离保证 ≤ 3
- 碰撞检测和避让功能正常工作（包括扇形区域和其他标签）
- 所有单元测试通过

### 后续建议

1. 可根据实际使用反馈调整方向容差（当前默认5°）
2. 可根据需要调整距离级别的粒度
3. 考虑添加用户可配置的参数（方向数量、最大距离等）

